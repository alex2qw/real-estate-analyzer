{% extends "base.html" %}

{% block title %}Dashboard - Real Estate Market Analyzer{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        margin-bottom: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    .stat-card h3 {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0;
    }
    .stat-card p {
        font-size: 1rem;
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
    }
    .hero {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 3rem;
        margin-bottom: 2rem;
        text-align: center;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    .hero h1 {
        color: #667eea;
        margin-bottom: 1rem;
    }
    .hero p {
        font-size: 1.1rem;
        color: #666;
    }
    .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    .feature-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }
    .feature-card:hover {
        transform: translateY(-5px);
    }
    .feature-icon {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }
    .loading {
        display: none;
    }
    .loading.show {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Hero Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="hero">
                <h1>üèòÔ∏è Real Estate Market Analyzer</h1>
                <p>Scrape property listings, analyze price trends, and generate market reports with visualizations</p>
            </div>
        </div>
    </div>

    <!-- Scraping Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">üï∑Ô∏è Scrape Properties</h4>
                </div>
                <div class="card-body">
                    <p>Click the button below to scrape property listings for a location and populate the database.</p>
                    <div class="input-group mb-3">
                        <input 
                            type="text" 
                            class="form-control" 
                            id="scrape-location" 
                            placeholder="Enter location (e.g., San Francisco)" 
                            value="San Francisco"
                        >
                        <button 
                            class="btn btn-primary" 
                            type="button" 
                            onclick="scrapeProperties()"
                        >
                            Scrape Now
                        </button>
                    </div>
                    <div id="scrape-status" style="display: none;">
                        <div class="alert" id="scrape-alert"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <div class="col-md-4">
            <div class="stat-card">
                <h3 id="total-properties">-</h3>
                <p>Total Properties</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <h3 id="avg-price">-</h3>
                <p>Average Price</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="stat-card">
                <h3 id="api-status">‚úì</h3>
                <p>API Status</p>
            </div>
        </div>
    </div>

    <!-- Features Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 style="color: white; margin-bottom: 2rem;">Key Features</h2>
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">üï∑Ô∏è</div>
                    <h4>Web Scraping</h4>
                    <p>Automatically scrape property listings from multiple real estate sources</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <h4>Price Analysis</h4>
                    <p>Track and analyze price trends over time with detailed statistics</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìà</div>
                    <h4>Market Reports</h4>
                    <p>Generate comprehensive market analysis reports by location</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìâ</div>
                    <h4>Visualizations</h4>
                    <p>Interactive Plotly charts showing trends and comparisons</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üîç</div>
                    <h4>Market Metrics</h4>
                    <p>KPIs including average prices, market heat, and anomalies</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üöÄ</div>
                    <h4>REST API</h4>
                    <p>Access market data programmatically with our full-featured API</p>
                </div>
            </div>
        </div>
    </div>

    <!-- API Testing Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">API Endpoints</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Endpoint</th>
                                    <th>Method</th>
                                    <th>Description</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>/api/health</code></td>
                                    <td><span class="badge bg-success">GET</span></td>
                                    <td>Health check</td>
                                    <td><button class="btn btn-sm btn-primary" onclick="testEndpoint('/api/health')">Test</button></td>
                                </tr>
                                <tr>
                                    <td><code>/api/properties</code></td>
                                    <td><span class="badge bg-success">GET</span></td>
                                    <td>Get all properties</td>
                                    <td><button class="btn btn-sm btn-primary" onclick="testEndpoint('/api/properties')">Test</button></td>
                                </tr>
                                <tr>
                                    <td><code>/api/market/summary</code></td>
                                    <td><span class="badge bg-success">GET</span></td>
                                    <td>Market summary</td>
                                    <td><button class="btn btn-sm btn-primary" onclick="testEndpoint('/api/market/summary')">Test</button></td>
                                </tr>
                                <tr>
                                    <td><code>/api/reports</code></td>
                                    <td><span class="badge bg-success">GET</span></td>
                                    <td>Market reports</td>
                                    <td><button class="btn btn-sm btn-primary" onclick="testEndpoint('/api/reports')">Test</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Response Display -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card" id="response-card" style="display: none;">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">API Response</h5>
                </div>
                <div class="card-body">
                    <pre id="response-body" style="max-height: 400px; overflow-y: auto;"><code></code></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Links -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Quick Links</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>üìö Documentation</h5>
                            <ul>
                                <li><a href="https://github.com/alex2qw/real-estate-analyzer" target="_blank">GitHub Repository</a></li>
                                <li><a href="https://github.com/alex2qw/real-estate-analyzer/blob/main/QUICKSTART.md" target="_blank">Quick Start Guide</a></li>
                                <li><a href="https://github.com/alex2qw/real-estate-analyzer/blob/main/README.md" target="_blank">Full Documentation</a></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>üõ†Ô∏è Development</h5>
                            <ul>
                                <li>Run tests: <code>make test</code></li>
                                <li>Format code: <code>make format</code></li>
                                <li>Lint: <code>make lint</code></li>
                                <li>View coverage: Open <code>htmlcov/index.html</code></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load statistics on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        checkApiHealth();
    });

    function loadStats() {
        // Get properties count
        fetch('/api/properties')
            .then(response => response.json())
            .then(data => {
                document.getElementById('total-properties').textContent = data.total || 0;
            })
            .catch(error => console.error('Error:', error));

        // Get market summary
        fetch('/api/market/summary')
            .then(response => response.json())
            .then(data => {
                const avgPrice = data.average_price ? `$${Math.round(data.average_price).toLocaleString()}` : 'N/A';
                document.getElementById('avg-price').textContent = avgPrice;
            })
            .catch(error => console.error('Error:', error));
    }

    function checkApiHealth() {
        fetch('/api/health')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'healthy') {
                    document.getElementById('api-status').textContent = '‚úì Online';
                } else {
                    document.getElementById('api-status').textContent = '‚úó Offline';
                }
            })
            .catch(error => {
                document.getElementById('api-status').textContent = '‚úó Error';
                console.error('Error:', error);
            });
    }

    function testEndpoint(endpoint) {
        const responseCard = document.getElementById('response-card');
        const responseBody = document.getElementById('response-body').querySelector('code');

        fetch(endpoint)
            .then(response => response.json())
            .then(data => {
                responseBody.textContent = JSON.stringify(data, null, 2);
                responseCard.style.display = 'block';
                responseCard.scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                responseBody.textContent = 'Error: ' + error.message;
                responseCard.style.display = 'block';
                responseCard.scrollIntoView({ behavior: 'smooth' });
            });
    }

    // Refresh stats every 30 seconds
    setInterval(loadStats, 30000);
    setInterval(checkApiHealth, 30000);

    function scrapeProperties() {
        const location = document.getElementById('scrape-location').value || 'San Francisco';
        const statusDiv = document.getElementById('scrape-status');
        const alertDiv = document.getElementById('scrape-alert');
        const button = event.target;

        // Show loading state
        button.disabled = true;
        button.textContent = 'Scraping...';
        statusDiv.style.display = 'none';

        fetch('/api/scrape', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ location: location })
        })
        .then(response => response.json())
        .then(data => {
            button.disabled = false;
            button.textContent = 'Scrape Now';
            statusDiv.style.display = 'block';

            if (data.success) {
                alertDiv.className = 'alert alert-success';
                alertDiv.innerHTML = `
                    <strong>‚úì Scraping Complete!</strong><br>
                    Scraped: ${data.scraped} listings<br>
                    Saved: ${data.saved} new properties<br>
                    Location: ${data.location}
                `;
            } else {
                alertDiv.className = 'alert alert-danger';
                alertDiv.innerHTML = `<strong>‚úó Error:</strong> ${data.error || 'Unknown error'}`;
            }

            // Refresh statistics
            setTimeout(loadStats, 500);
        })
        .catch(error => {
            button.disabled = false;
            button.textContent = 'Scrape Now';
            statusDiv.style.display = 'block';
            alertDiv.className = 'alert alert-danger';
            alertDiv.innerHTML = `<strong>‚úó Error:</strong> ${error.message}`;
        });
    }
</script>
{% endblock %}
