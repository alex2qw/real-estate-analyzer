{% extends "base.html" %}

{% block title %}Dashboard - Real Estate Market Analyzer{% endblock %}

{% block content %}
<!-- Top Bar -->
<div class="top-bar">
    <h1><i class="bi bi-grid-1x2-fill me-2"></i>Dashboard</h1>
    <div class="d-flex gap-2">
        <a href="/properties" class="btn btn-outline-primary">View Properties</a>
        <a href="/scrape" class="btn btn-primary"><i class="bi bi-cloud-download"></i> Scrape Data</a>
    </div>
</div>

<!-- Stats Row -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon primary"><i class="bi bi-buildings"></i></div>
            <div class="stat-info">
                <h3 id="total-properties">0</h3>
                <p>Total Properties</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon success"><i class="bi bi-currency-dollar"></i></div>
            <div class="stat-info">
                <h3 id="avg-price">$0</h3>
                <p>Average Price</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon warning"><i class="bi bi-geo-alt"></i></div>
            <div class="stat-info">
                <h3 id="total-cities">0</h3>
                <p>Cities Covered</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card">
            <div class="stat-icon secondary"><i class="bi bi-check-circle"></i></div>
            <div class="stat-info">
                <h3 id="api-status">Online</h3>
                <p>API Status</p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions & Chart -->
<div class="row g-4 mb-4">
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header"><i class="bi bi-cloud-download me-2"></i>Quick Scrape</div>
            <div class="card-body">
                <p class="text-muted mb-3">Add new property listings to your database</p>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="scrape-location" placeholder="Enter location..." value="San Francisco, USA">
                    <button class="btn btn-primary" onclick="quickScrape()"><i class="bi bi-download"></i></button>
                </div>
                <div id="scrape-result"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header"><i class="bi bi-bar-chart me-2"></i>Price Distribution</div>
            <div class="card-body">
                <div id="priceChart" style="height: 250px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Properties -->
<div class="row g-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-clock-history me-2"></i>Recent Properties</span>
                <a href="/properties" class="btn btn-sm btn-light">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Address</th>
                                <th>City</th>
                                <th>Price</th>
                                <th>Type</th>
                                <th>Beds</th>
                                <th>Baths</th>
                                <th>Sqft</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recent-properties">
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    No properties yet. Click "Scrape Data" to add some!
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardData();
    });

    function loadDashboardData() {
        fetch('/api/properties?per_page=10')
            .then(r => r.json())
            .then(data => {
                document.getElementById('total-properties').textContent = data.total;
                updateRecentProperties(data.properties);
                updatePriceChart(data.properties);
                const cities = [...new Set(data.properties.map(p => p.city))];
                document.getElementById('total-cities').textContent = cities.length;
            });

        fetch('/api/market/summary')
            .then(r => r.json())
            .then(data => {
                const avg = data.average_price ? formatPrice(Math.round(data.average_price)) : '$0';
                document.getElementById('avg-price').textContent = avg;
            });

        fetch('/api/health')
            .then(r => r.json())
            .then(data => {
                document.getElementById('api-status').innerHTML = 
                    data.status === 'healthy' ? '<span class="text-success">Online</span>' : '<span class="text-danger">Offline</span>';
            });
    }

    function updateRecentProperties(properties) {
        const tbody = document.getElementById('recent-properties');
        if (properties.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">
                <i class="bi bi-inbox fs-1 d-block mb-2"></i>No properties yet. Click "Scrape Data" to add some!</td></tr>`;
            return;
        }
        tbody.innerHTML = properties.slice(0, 10).map(p => `
            <tr>
                <td><strong>${p.address || 'N/A'}</strong></td>
                <td>${p.city || 'N/A'}, ${p.state || ''}</td>
                <td class="text-primary fw-bold">${formatPrice(p.price)}</td>
                <td><span class="badge badge-${p.property_type || 'house'}">${p.property_type || 'N/A'}</span></td>
                <td><i class="bi bi-door-open"></i> ${p.bedrooms || '-'}</td>
                <td><i class="bi bi-droplet"></i> ${p.bathrooms || '-'}</td>
                <td>${p.square_feet ? p.square_feet.toLocaleString() : '-'}</td>
                <td><a href="/property/${p.id}" class="btn btn-sm btn-outline-primary"><i class="bi bi-eye"></i></a></td>
            </tr>
        `).join('');
    }

    function updatePriceChart(properties) {
        if (properties.length === 0) {
            document.getElementById('priceChart').innerHTML = '<p class="text-center text-muted py-5">No data available</p>';
            return;
        }
        Plotly.newPlot('priceChart', [{
            x: properties.map(p => p.price),
            type: 'histogram',
            marker: { color: 'rgba(102, 126, 234, 0.7)', line: { color: 'rgba(102, 126, 234, 1)', width: 1 } },
            nbinsx: 10
        }], {
            margin: { t: 20, r: 20, b: 40, l: 60 },
            xaxis: { title: 'Price ($)' },
            yaxis: { title: 'Count' },
            paper_bgcolor: 'transparent',
            plot_bgcolor: 'transparent'
        }, { responsive: true });
    }

    function quickScrape() {
        const location = document.getElementById('scrape-location').value;
        const resultDiv = document.getElementById('scrape-result');
        resultDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Scraping...</div>';
        
        fetch('/api/scrape', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ location: location })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                resultDiv.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> Scraped ${data.scraped}, saved ${data.saved} new!</div>`;
                loadDashboardData();
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ${data.error}</div>`;
            }
        })
        .catch(err => {
            resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ${err.message}</div>`;
        });
    }
</script>
{% endblock %}
